<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compiscript IDE — TAC Live</title>

  <!-- Split.js para paneles redimensionables (sólo si quieres ampliar) -->
  <script src="https://unpkg.com/split.js/dist/split.min.js"></script>

  <!-- Monaco loader (CDN). Si trabajas offline, usa una copia local de monaco. -->
  <!-- Monaco loader deshabilitado: usando fallback textarea -->

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1720; --panel:#10161b; --accent:#7c3aed; --muted:#9aa4b2; --card:#0b1220;
      --glass: rgba(255,255,255,0.03);
      --radius:10px;
      --gap:10px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body,#app{height:100%; margin:0; background: linear-gradient(180deg,#071226 0%, #081226 80%); color: #e6eef6;}
    #app{display:flex; flex-direction:column; gap:var(--gap); padding:12px;}
    .toolbar{
      display:flex; gap:8px; align-items:center; padding:8px; background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
      border-radius: 12px; box-shadow: 0 6px 16px rgba(2,6,23,0.6);
      user-select:none;
    }
    .btn{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color:var(--muted); border:1px solid rgba(255,255,255,0.03); padding:8px 12px; border-radius:8px;
      cursor:pointer; font-weight:600;
    }
    .btn.primary{ background:linear-gradient(90deg,var(--accent), #5b21b6); color:white; box-shadow: 0 6px 20px rgba(124,58,237,0.18); }
    .btn:active{ transform:translateY(1px); }
    .spacer{flex:1}
    .status{font-size:.9rem; color:var(--muted)}
    /* Layout */
    .workspace{display:flex; height:calc(100% - 72px); gap:10px;}
    .left, .right { background:var(--panel); border-radius:var(--radius); overflow:hidden; box-shadow: 0 8px 30px rgba(2,6,23,0.6);}
    .left{flex:1; display:flex; flex-direction:column}
    .right{width:420px; display:flex; flex-direction:column;}
    .editor-toolbar{display:flex; gap:8px; align-items:center; padding:8px; background:var(--glass); border-bottom:1px solid rgba(255,255,255,0.02)}
    .panel-title{font-size:.9rem; color:var(--muted); padding-left:8px}
    .panel-body{height:100%; overflow:auto;}
    .card { padding:8px; height:100%; display:flex; flex-direction:column; gap:8px;}
    pre {white-space:pre-wrap; word-break:break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px; color:#dbeafe;}
    .small-muted{font-size:.8rem; color:var(--muted)}
    .kbd{background:rgba(255,255,255,0.03); padding:4px 6px; border-radius:6px; font-weight:700; color:var(--muted); font-size:.85rem;}
    /* ensure editor has a real height for monaco */
    #editor-container { height: 100%; min-height: 200px; }
    @media (max-width:900px){
      .workspace{flex-direction:column}
      .right{width:unset;height:360px}
    }
  </style>
</head>
<body>
  <div id="app" role="application" aria-label="Compiscript IDE">
    <div class="toolbar" role="toolbar" aria-label="Acciones">
      <button class="btn" id="btn-load">Abrir (reload)</button>
      <button class="btn primary" id="btn-compile">Generar TAC</button>
      <button class="btn" id="btn-save">Guardar</button>
      <div class="spacer"></div>
      <div class="status" id="status">Listo</div>
      <div style="width:12px"></div>
      <div class="small-muted">Atajos: <span class="kbd">Ctrl+S</span> guardar — <span class="kbd">Ctrl+Enter</span> compilar</div>
    </div>

    <div class="workspace" id="workspace">
      <div class="left" id="left-pane">
        <div class="editor-toolbar">
          <div class="panel-title">Editor — <span id="filename">input.cps</span></div>
          <div class="spacer"></div>
          <div class="small-muted" id="editor-info">Sin cambios</div>
        </div>
        <div id="editor-container"></div>
      </div>

      <div class="right" id="right-pane">
        <div style="display:flex; gap:8px; padding:8px; border-bottom:1px solid rgba(255,255,255,0.02); background:var(--glass);">
          <button class="btn" data-view="pretty" id="tab-pretty">TAC (pretty)</button>
          <button class="btn" data-view="raw" id="tab-raw">TAC (raw)</button>
          <button class="btn" data-view="logs" id="tab-logs">Logs</button>
          <button class="btn" data-view="runtime" id="tab-runtime">Runtime</button>
        </div>

        <div id="view-pretty" class="panel-body card" style="display:block;">
          <div class="small-muted">TAC (legible) <span id="pretty-time" style="float:right;"></span></div>
          <pre id="pretty-content" aria-live="polite">Cargando...</pre>
        </div>

        <div id="view-raw" class="panel-body card" style="display:none;">
          <div class="small-muted">TAC (cuádruplas)</div>
          <pre id="raw-content">Cargando...</pre>
        </div>

        <div id="view-logs" class="panel-body card" style="display:none;">
          <div class="small-muted">Logs del servidor</div>
          <pre id="logs-content">Cargando...</pre>
        </div>

        <div id="view-runtime" class="panel-body card" style="display:none;">
          <div class="small-muted">Runtime frames / info</div>
          <pre id="runtime-content">No hay endpoint runtime</pre>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========================
   Configuración Monaco
   ======================== */
require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.45.1/min/vs' }});
let editor = null;
let currentFilename = 'input.cps';
let lastSaved = null;

require(['vs/editor/editor.main'], function() {
  editor = monaco.editor.create(document.getElementById('editor-container'), {
    value: '// Cargando archivo...',
    language: 'javascript',
    theme: 'vs-dark',
    fontSize: 13,
    minimap: { enabled: false },
    scrollBeyondLastLine: false,
    automaticLayout: true,
    lineNumbers: "on",
    wordWrap: "off",
    tabSize: 2
  });
  // intenta cargar archivo real
  loadEditorFile();
});

/* ========================
   UI helpers
   ======================== */
const statusEl = document.getElementById('status');
const setStatus = s => { statusEl.textContent = s; };
const setEditorInfo = t => { document.getElementById('editor-info').textContent = t; };

/* ========================
   Tabs
   ======================== */
document.querySelectorAll('[data-view]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const view = btn.getAttribute('data-view');
    ['pretty','raw','logs','runtime'].forEach(v=>{
      document.getElementById('view-'+v).style.display = (v===view)?'block':'none';
    });
  });
});

/* ========================
   Fetch & SSE (update content)
   ======================== */
async function fetchAndUpdate(){
  try{
    // TAC legible
    const p = await fetch('/tac');
    if(p.ok){
      document.getElementById('pretty-content').textContent = await p.text();
      document.getElementById('pretty-time').textContent = new Date().toLocaleTimeString();
    } else {
      document.getElementById('pretty-content').textContent = 'TAC no disponible (404)';
    }

    // TAC raw
    const r = await fetch('/raw');
    if(r.ok) document.getElementById('raw-content').textContent = await r.text();
    else document.getElementById('raw-content').textContent = 'TAC raw no disponible';

    // logs
    const l = await fetch('/logs');
    if(l.ok) document.getElementById('logs-content').textContent = await l.text();
    else document.getElementById('logs-content').textContent = 'Logs no disponibles';

    // runtime (opcional; si hay endpoint personalizado)
    const rt = await fetch('/runtime').catch(()=>null);
    if(rt && rt.ok){
      const j = await rt.json();
      document.getElementById('runtime-content').textContent = JSON.stringify(j, null, 2);
    } else if (!rt) {
      // si no hay endpoint runtime, dejamos el mensaje por defecto
    } else {
      document.getElementById('runtime-content').textContent = 'Runtime no disponible';
    }
  } catch(e){
    console.warn("Error fetching dynamic content", e);
  }
}

// conectamos SSE para recibir notificaciones del servidor (si está disponible)
let evtSource = null;
function setupSSE(){
  if(typeof(EventSource) === "undefined") return;
  try {
    evtSource = new EventSource('/events');
    evtSource.addEventListener('init', (e)=> {
      // console.log('sse init', e.data);
      fetchAndUpdate();
    });
    evtSource.addEventListener('update', (e)=> {
      // payload puede traer una vista previa; pedimos al servidor los archivos actualizados
      fetchAndUpdate();
    });
    evtSource.addEventListener('error', (e)=> {
      // console.warn('SSE error', e);
    });
  } catch(e){
    console.warn('SSE no disponible', e);
  }
}

/* start */
fetchAndUpdate();
setupSSE();
setInterval(fetchAndUpdate, 3000); // poll cada 3s como fallback

/* ========================
   Editor operations (load/save/compile)
   ======================== */

// intenta cargar desde /api/editor/load?file=... ; si falla intenta /input.cps u otros fallbacks
async function loadEditorFile(){
  setEditorInfo("Cargando...");
  const tries = [
    '/api/editor/load?file=' + encodeURIComponent(currentFilename),
    '/input.cps',
    '/static/input.cps',
    '/' + currentFilename
  ];
  for(const url of tries){
    try {
      const resp = await fetch(url);
      if(resp.ok){
        const txt = await resp.text();
        editor.setValue(txt);
        lastSaved = txt;
        setEditorInfo("Cargado (" + url + ")");
        return;
      }
    } catch(e){
      // ignore and continue
    }
  }
  // si llegamos aquí, no hay endpoint; cargamos ejemplo
  const sample = `// Nuevo archivo ${currentFilename}\n// Escribe tu código Compiscript aquí\n\nfunc main() {\n  // ejemplo\n}\n`;
  editor.setValue(sample);
  lastSaved = sample;
  setEditorInfo("Archivo por defecto (no se encontró fuente remota)");
}

// Guarda: intenta /api/save; si no está disponible, crea una descarga para no perder contenido
async function saveEditor(){
  const content = editor.getValue();
  setStatus('Guardando...');
  // primer intento: endpoint oficial
  try {
    const r = await fetch('/api/save', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({filename: currentFilename, content})
    });
    if(r.ok){
      lastSaved = content;
      setEditorInfo('Guardado (servidor)');
      setStatus('Guardado');
      return;
    }
  } catch(e){ /* endpoint inexistente */ }

  // fallback: descarga del archivo localmente
  try {
    const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = currentFilename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    setEditorInfo('Guardado local (descarga)');
    setStatus('Guardado (descarga)');
    lastSaved = content;
  } catch(e){
    setEditorInfo('Error al guardar');
    setStatus('Error');
  }
}

// Compilar: intenta /api/compile ; si no existe sólo muestra mensaje
async function compileTAC(){
  setStatus('Compilando...');
  try {
    const r = await fetch('/api/compile', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({filename: currentFilename})
    });
    if(r.ok){
      setStatus('Compilado');
      fetchAndUpdate();
      return;
    } else {
      // si hay respuesta con texto, mostramos parte
      const txt = await r.text().catch(()=>'');
      setStatus('Error: ' + (txt.substring(0,60) || 'compile failed'));
      return;
    }
  } catch(e){
    // endpoint no disponible en backend mínimo: avisamos y forzamos fetchAndUpdate
    setStatus('Compile no soportado por el servidor');
    fetchAndUpdate();
  }
}

/* ========================
   Bind botones y shortcuts
   ======================== */
document.getElementById('btn-save').addEventListener('click', saveEditor);
document.getElementById('btn-compile').addEventListener('click', compileTAC);
document.getElementById('btn-load').addEventListener('click', ()=>{ loadEditorFile(); fetchAndUpdate(); });

window.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); saveEditor(); }
  if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); compileTAC(); }
});

/* unsaved indicator */
setInterval(()=> {
  const changed = editor && (editor.getValue() !== (lastSaved||''));
  setEditorInfo(changed ? 'Cambios no guardados' : 'Sin cambios');
}, 600);

/* cuando se guarda desde servidor, el save endpoint podría devolver el contenido escrito
   si lo hace, podríamos actualizar lastSaved — el presente cliente maneja lastSaved en los casos ok. */

</script>

</body>
</html>
